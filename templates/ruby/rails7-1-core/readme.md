# Create a rails microservices app


### Docker commands

Run ash shell on the server, ash is the shell environment for alpine

```bash
docker container run -v $(pwd):/usr/src/app -it klueless/web-{{dashify settings.application}} ash
```

Start rails webserver

```bash
docker container run -v $(pwd):/usr/src/app -it -p {{settings.rails_port}}:{{settings.rails_port}} klueless/web-{{dashify settings.application}}
```

### Generator Process

Go to generator and set the filter to pre-setup files for your particular application. The following filter should work.

```
00 {{dashify settings.application}}
```

* Create the first 6 files
* Run init-1-main.sh
  * This will run the following 
  * setup-1.sh
  * setup-2.sh

```bash
bash init-1-main.sh
```

* Remove 00 from filter
* Generate all files after 00


### Manual Process

* Open multiple terminal window tabs with these folders

```bash
# Terminal 1
#
# This will be related to our new Rails Application
#
# Go to the location where you will be building your app
cd ~/Desktop/klueless.io

# (Optional) Remove existing folder if it exists
rm -rf {{settings.application}}

# Create a new folder
mkdir {{settings.application}}
cd {{settings.application}}

# Terminal 2
#
# This will be related configurating the Klue-Generator (V1) for building out a new Rails Application
#
# Setup new data structure for your [new] app
cd ~/Desktop/t99-hb/_/generator-data/new-rails-app
cp template.csv {{settings.application}}.csv

cd ..
mkdir {{settings.application}}
mkdir {{settings.application}}/models

# close terminal and edit and create some model files
{{settings.application}}.csv
```

# Alter Application Generator

Create an entry in Application Generator File System
```
~/Desktop/t99-hb/server/api/fileSystem/dave-linux.js
```

~/Desktop/klueless.io/{{settings.application}}

```json
z{{curly-open 1}}
    key: '{{settings.application}}',
    path: '~/Desktop/klueless.io/{{settings.application}}'
{{curly-close 1}}
```

# Postgres
Ensure that you have installed Postgres

# Create Postgres Login Roles for Application [option 1] 

This example assumes the database is called {{settings.database_name}}

```bash
sudo -i
su - postgres

# (Optional) Remove existing databases if you are rebuilding this application and need to start again
dropdb {{settings.database_name}}
dropdb {{settings.database_name}}_test

# Create new user and databases
createuser --superuser --pwprompt {{settings.database_name}}
createdb --owner={{settings.database_name}} {{settings.database_name}}
createdb --owner={{settings.database_name}} {{settings.database_name}}_test
exit
exit          # exit again
```

# Create Postgres Login Roles via PG Admin [option 2]

```
Create login role : {{settings.database_name}}
Set password      : {{settings.database_name}}
Give 'Super User' previledge
```

# Create GEM SET 
Create a Gem for the app you are building and install rails into that gemset

```bash
# Know what is currently available
rvm gemset list

# (Becareful) Would you like to delete any of these

rvm --force gemset delete {{settings.application}}

# Using app name and rails verion
rvm use ruby-{{settings.ruby_version}}@{{settings.application}}{{settings.rails_version}} --ruby-version --create
# or 
# Using app name only
rvm use ruby-{{settings.ruby_version}}@{{settings.application}} --ruby-version --create
# or 
# Using dbname and rails version (optional, use if you have multiple services that you want same gemset)
rvm use ruby-{{settings.ruby_version}}@{{settings.database_name}}{{settings.rails_version}} --ruby-version --create

# or
# Use an existing gemset
# Using app name only
rvm gemset use {{dashify settings.application}}

rvm gemset list

# Install Rails
gem install rails
```

# Fixing Previous Releases

```
spring stop
```

# Create a new rails app 

Create a new rails app without standard Test Framework and using Postgres

```bash

# Create Rails App (with posgress and not using default test setup)
rails new . -T -d postgresql --webpack=vue
bundle install

# Manual add VUE
bundle exec rails webpacker:install:vue

# Manual add Angular
bundle exec rails webpacker:install:angular
```

# Generate pre-assets

* 01 - ReadMe.md
* 02 - .gitignore
* 02 - GemFile

```bash
bundle install
```

# Before working with .git

##Open application in your favourite editor 

By opening the application in favourite editor you force the creation of any IDE/Editor 
files that are auto generated by that editor. 

It is important to ignore folders, files or patterns that are related to your development 
environment.

# .git - Initial commit

```bash
# Check for any IDE/Editor files that you don't need in .git 
# and ensure they are dealt with in .gitignore

git status
git add .
git commit -am 'Initial Application'
git status

# if you need to reset back to this commit then run
# git reset --hard HEAD
```

# Run generators for 3rd party addons 

* ActiveAdmin
* Devise
* Guard
* WebPacker

## Generate Active Admin (admin_user)

```bash
rails generate active_admin:install

# If this fails, try running 
# spring stop
```

## Setup Devise / Active Admin

```bash
rails generate devise:install
rails generate devise user
# If needed
# rails generate devise:views
```

## Setup RSPEC / Guard

```bash
rails generate rspec:install
bundle binstubs rspec-core
bundle binstubs guard

# Done by code generator
# guard init
```

## Setup Webpacker / Yarn etc...

```bash
# Maybe
# sudo apt remove cmdtest
# sudo apt remove yarn

# Maybe
# Install yarn globally using npm
# sudo npm install -g yarnpkg
```

## Remove rudundant migrations (Active admin can add extra's)

```bash
# Check for any IDE/Editor files that you don't need in .git 
# and ensure they are dealt with in .gitignore

git status
git add .
git commit -am 'Addons attached to application ... ActiveAdmin, Devise, Guard and WebPacker'
git status
```

# Generate the microservice application structure

Work through the rest of the asset files and start generating your Microservice Architecture

# Alter file permissions on Kfiles and Hooks

For Ubuntu

```bash
chmod +x hooks/update-version
chmod +x hooks/pre-commit
chmod +x bin/k
chmod +x bin/kgitsync
chmod +x bin/khotfix
chmod +x bin/kmigrate
chmod +x bin/krollback
```

# Initialize Rails Microservice

```bash
bundle install
```

# Remove ActiveAdminComments

remove the file: 
```
db/migrate/XXXXXXXXXXXXXX_devise_create_admin_comments.rb
```

# Create Migrations and do intial seed


```bash

# rake db:migrate
# rake db:migrate RAILS_ENV=test
# or
./bin/kmigrate

rake db:seed
```

# Run Rails

```
rails s
```

# Run Web Packer

```bash
./bin/webpack-dev-server
```

# Test Website
Visit http://localhost:{{settings.rails_port}}

# Test Active Admin
Visit http://localhost:{{settings.rails_port}}/admin and log in using:

User: admin@admin.com
Password: password

# .git - Final application commit

```bash
git status
git add .
git commit -am 'Microservice Application'
git status

# if you need to reset back to this commit then run
# git reset --hard HEAD
```

# Bit Bucket

Sign into an account on Bit Bucket

* Create repository : {{settings.application}}
* For owner         : {{settings.bit_bucket_account}}

A URL like this should have been created:

* https://{{settings.bit_bucket_user}}@bitbucket.org/{{settings.bit_bucket_account}}/{{settings.application}}.git


# GIT Repository

If you need to install git flow, look here: [https://github.com/nvie/gitflow/wiki/Installation](https://github.com/nvie/gitflow/wiki/Installation)

Set up

```
git flow init
git status
git branch
git checkout master
git status

git remote add origin git@bitbucket.org:{{settings.bit_bucket_account}}/{{dashify settings.application}}.git

git push --set-upstream origin master
git checkout develop
git push --set-upstream origin develop

```

Create first hotfix manually

```bash

git flow hotfix start v0.01.001
# Alter any file you like
# SUGGESTION
# Remember to go back and change comments in seed

git add .
git commit -am 'First Hotfix, setup the version system and alter seed.rb'
git flow hotfix finish v0.01.001
git push

git checkout master
git push

#./bin/kgit_sycn
```





# Changes

* Remove sync buttons from user and admin user
* Split up destroy and sync into seperate classes

* Time wasters
  * Setup seed data
  
* Dealing with custom data in unit tests eg. emails and passwords

* users & Admin Users
  - Controller.create/update/destroy raise 'not implemented'

* Add a postgres extension migration

  - enable_extension('citext') unless extensions.include?('citext')

* Common Patterns
  - When I was adding custom WebPack configuration for webpacker, I followed these instructions and made two files in my system, those two files represent useful paterns that could be stored in the template system
  - https://github.com/rails/webpacker/blob/master/docs/webpack.md
  - _/generator-templates/new-patterns/webpack/environment.js

* Pattern WebPacker
  - Debug WebPacker Config
    - See: https://makandracards.com/makandra/53784-debugging-webpacker-config
    - throw JSON.stringify(environment, null, 2)
  - Remove Specific WebPack Warnings
    - https://webpack.js.org/configuration/stats/
    - // warnings: true,

* DSL for REST
  - Might be good to generate a GEM for each api that has all the code needed to use the API from another rails Application
  - https://github.com/domaindrivendev/rswag
  - https://github.com/remiprev/her
  - https://medium.com/otavio-henrique/creating-simple-rest-api-with-rails-5-1ba71b37cad
  - https://medium.com/otavio-henrique/creating-simple-rest-api-with-rails-5-1ba71b37cad    
  - https://medium.com/@sushildamdhere/how-to-document-rest-apis-with-swagger-and-ruby-on-rails-ae4e13177f5d
  - https://revs.runtime-revolution.com/integrating-a-third-party-api-with-rails-5-134f960ddbba
  - https://www.twilio.com/blog/2015/10/4-ways-to-parse-a-json-api-with-ruby.html


New Templates
  - _/generator-templates/new-rails-app/new-rails-08-active-admin_time_input.rb
  - _/generator-templates/new-rails-app/new-rails-08-active-admin_timestamp_input.rb
  - _/generator-templates/new-rails-app/new-rails-08-active-admin_date_input.rb
